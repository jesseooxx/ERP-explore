# 產品主檔 BOM 結構說明

## 發現來源

**ERP 畫面**: 產品基本資料 → Tab「3.組合關係」
**截圖日期**: 2025-12-18
**資料來源**: 192.168.252.16 / datawin (正式環境)

---

## 074027 產品資訊

### 基本資料 (tem01)

| 欄位 | 值 | 說明 |
|------|-----|------|
| **產品編號** | 074027 | ea02 |
| **產品名稱** | 740 SW 60 | ea03 |
| **產品說明** | FINISHED SOCKET | ea03 第2行 |
| **產品大類** | 10001 | ea05 |
| **產品型錄** | TAIWAN | ea06 |
| **產品來源** | 1 國內採購 | - |
| **國內訂價** | NT$ 261.14 | - |
| **出口訂價** | US$ 10.76 | - |
| **業務成本** | NT$ 261.14 | - |

---

## 組合關係 (BOM)

### Tab 結構

畫面上的 Tab 順序：
1. 多存描述
2. 供應商
3. **組合關係** ← 當前
4. 進口設定
5. 售價等級
6. 自定欄位
7. 贈品配件
8. 技術資料

### 組合明細表格欄位

| 欄位名稱 | 說明 | 範例值 |
|---------|------|--------|
| 預次 | 序號 | 1, 2 |
| Main | 項目類型 (Y=主要/N=次要) | Y, N |
| 組件編號 | 子零件編號 | 074027-MAIN |
| 組件數量 | 需求數量比例 | 1 / 1 |
| 幣別 | 成本幣別 | NT$ |
| 單位成本 | 單個成本 | 260.44, 0.7 |
| 供應商 | 供應商代碼 | 0735, 02291 |
| 序號 | BOM 序號 | 3, 1 |
| 損耗率% | 耗損百分比 | 0 |

---

## 074027 標準 BOM

從 ERP UI 擷取的標準組合：

| 序號 | 類型 | 組件編號 | 組件數量 | 幣別 | 單位成本 | 供應商代碼 | 供應商名稱 | 損耗率 |
|------|------|----------|----------|------|----------|-----------|-----------|--------|
| 3 | Y (Main) | 074027-MAIN | 1 / 1 | NT$ | 260.44 | 0735 | 萬典實業 | 0 |
| 1 | N | 074027-LABEL | 1 / 1 | NT$ | 0.7 | 02291 | 台寶數位 | 0 |

**總成本**: 260.44 + 0.7 = **261.14 NT$**

---

## 資料表對應分析

### 可能的儲存位置

根據現有資料表結構分析：

#### 方案 A: tem04 (產品標準 BOM)
```sql
SELECT COLUMN_NAME FROM INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_NAME = 'tem04';

-- 結果：
ed010  -- 類型 (P=Product?)
ed011  -- 產品編號或訂單編號
ed02   -- 組件編號
ed03   -- 組件數量 (float)
ed04   -- 類型標記 (M=Main, C=Component?)
ed05   -- 說明 (varchar 60)
```

**問題**: tem04 欄位不足以儲存供應商、成本等資訊

#### 方案 B: 組合表 + 關聯查詢

可能的設計：
1. **tem04** - 儲存組合關係 (主產品 → 子零件)
2. **tem01** - 儲存產品基本資訊和成本
3. **UI 動態查詢** - 從 tem01 取得子零件的供應商和成本

查詢邏輯：
```sql
SELECT
    t4.ed010,           -- 類型
    t4.ed011,           -- 主產品
    t4.ed02,            -- 組件編號
    t4.ed03,            -- 組件數量
    t4.ed04,            -- Main標記
    t1_sub.供應商,       -- 從子零件的產品主檔取得
    t1_sub.成本,         -- 從子零件的產品主檔取得
    t4.ed05             -- 說明
FROM tem04 t4
LEFT JOIN tem01 t1_sub ON t1_sub.ea02 = t4.ed02  -- 關聯子零件資料
WHERE t4.ed011 = '074027'
ORDER BY t4.ed010;
```

#### 方案 C: tem05 (訂單專屬 BOM)

前面已確認 tem05 是訂單專屬的組合關係：
```sql
ee011 = S/C 編號 (訂單)
ee02 = 主產品
ee03 = 子組件
```

但產品主檔的標準 BOM 應該**不依賴訂單**。

---

## 兩種 BOM 的關係

### 產品標準 BOM (Product BOM)
- **位置**: 產品基本資料 → 組合關係 Tab
- **用途**: 定義產品的標準組成
- **資料表**: tem04 或類似表格
- **特性**:
  - 不依賴訂單
  - 定義產品的預設組合
  - 包含標準成本

### 訂單專屬 BOM (Order BOM)
- **位置**: 銷售訂單 → 產品組合視窗
- **用途**: 特定訂單的組合計算
- **資料表**: tem05
- **特性**:
  - 依訂單 (S/C) 儲存
  - 可能從產品標準 BOM 複製
  - 可針對訂單調整

### 流程關係

```
產品主檔 BOM (tem04)
    ↓ (複製/參考)
訂單專屬 BOM (tem05)
    ↓ (計算)
顯示在訂單明細中
```

---

## 資料不一致分析

### 為何本地資料庫找不到？

1. **資料庫版本差異**
   - 本地: 2017年備份 (BK7.bak)
   - 正式: 2025年最新資料
   - 074027 是 2017 年後新增產品

2. **表格結構可能變更**
   - 2017 → 2025 可能有結構調整
   - 新增欄位或新表格

3. **資料建立時間**
   - 074027 在 2017 備份後才建立
   - 標準 BOM 也是後來設定的

---

## 下一步研究方向

### 要完整理解需要：

1. **連接正式環境查詢**
   ```sql
   -- 需要 sa 密碼才能連線
   Server: 192.168.252.16
   Database: datawin
   User: sa
   ```

2. **查詢產品標準 BOM**
   ```sql
   SELECT * FROM tem04 WHERE ed011 = '074027';
   -- 或
   SELECT * FROM [產品BOM表] WHERE 產品編號 = '074027';
   ```

3. **追蹤 UI 查詢**
   - 用 SQL Profiler 監控 ERP 執行的 SQL
   - 確認實際查詢哪些表格

4. **反編譯 DLL**
   - 分析 xtf1i01.dll 的 SQL 查詢邏輯
   - 找出產品 BOM 的確切表格名稱

---

## 臨時解決方案

### 在本地模擬標準 BOM

由於無法連接正式環境，可以在本地建立類似結構：

```sql
-- 在 tem04 中插入 074027 的標準 BOM
INSERT INTO tem04 (ed010, ed011, ed02, ed03, ed04, ed05)
VALUES
('P', '074027', '074027-MAIN', 1.0, 'M', '740 SW 60 FINISHED SOCKET'),
('P', '074027', '074027-LABEL', 1.0, 'C', 'LABEL');

-- 或建立新的產品 BOM 表
CREATE TABLE ProductBOM (
    ProductCode VARCHAR(20),     -- 主產品編號
    ComponentCode VARCHAR(20),   -- 組件編號
    ComponentQty FLOAT,          -- 數量比例
    IsMain CHAR(1),             -- Y=主要零件
    UnitCost FLOAT,             -- 單位成本
    Currency VARCHAR(5),        -- 幣別
    SupplierCode VARCHAR(10),   -- 供應商
    LossRate FLOAT,             -- 損耗率
    SeqNo INT,                  -- 序號
    PRIMARY KEY (ProductCode, ComponentCode)
);

-- 插入 074027 標準 BOM
INSERT INTO ProductBOM VALUES
('074027', '074027-MAIN', 1.0, 'Y', 260.44, 'NT$', '0735', 0, 3),
('074027', '074027-LABEL', 1.0, 'N', 0.7, 'NT$', '02291', 0, 1);
```

---

## 結論

1. **產品主檔的標準 BOM** 存在於正式環境
2. 可能儲存在 **tem04** 或專門的產品 BOM 表
3. UI 透過關聯查詢顯示供應商和成本資訊
4. **訂單 BOM (tem05)** 可能從標準 BOM 複製而來
5. 要完整理解需要連接正式環境或分析 DLL

---

## 附錄：畫面資訊

**系統資訊** (截圖底部)：
- 使用者: T401 T200M-ta4i01
- 伺服器: **192.168.252.16**
- 資料庫: **datawin**
- 使用者: **I18**
- SQLUPD 套件日期: 2020/03/19
