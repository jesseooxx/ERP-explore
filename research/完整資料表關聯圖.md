# DataWin ERP 完整資料表關聯圖

**更新日期**: 2025-12-18
**資料來源**: 實際 SQL 查詢 + ERP UI 驗證

---

## 核心資料流程

```
┌─────────────────────────────────────────────────────────┐
│                     產品主檔層                            │
└─────────────────────────────────────────────────────────┘

              ┌──────────────┐
              │   tdm05      │
              │ 產品標準 BOM  │
              │ (Product BOM)│
              └──────┬───────┘
                     │
         定義產品的標準組合關係
                     │
                     ↓

┌─────────────────────────────────────────────────────────┐
│                     訂單層級                             │
└─────────────────────────────────────────────────────────┘

    ┌──────────────┐          ┌──────────────┐
    │   tfm01      │          │   tqm01      │
    │ 銷售主檔      │          │ 報價主檔      │
    │ (S/C Master) │          │ (Quotation)  │
    └──────┬───────┘          └──────┬───────┘
           │                         │
           ↓                         ↓
    ┌──────────────┐          ┌──────────────┐
    │   tfm02      │          │   tqm02      │
    │ 銷售明細      │          │ 報價明細      │
    │ (S/C Detail) │          │              │
    └──────┬───────┘          └──────────────┘
           │
           │ 當輸入產品編號時
           │
           ↓
    ┌──────────────┐
    │   tem05      │
    │ 訂單專屬 BOM  │
    │ (Order BOM)  │
    └──────────────┘
           ↑
           │ 從 tdm05 複製
           │

┌─────────────────────────────────────────────────────────┐
│                   排程與出貨層級                          │
└─────────────────────────────────────────────────────────┘

    ┌──────────────┐          ┌──────────────┐
    │   tfm03      │          │   tfm04      │
    │ 排程明細      │          │ 排程彙總      │
    │              │─────────▶│              │
    └──────────────┘          └──────────────┘
```

---

## 詳細表格關聯

### 1. 產品標準 BOM 層

#### tdm05 - 產品標準組合關係

**主鍵**: (de01, de02)

| 欄位 | 說明 | 關聯 |
|------|------|------|
| de01 | 產品編號 | → 產品主檔 (未確認表名) |
| de02 | 組件編號 | → 自身或產品主檔 |
| de03/de04 | 比例 (分子/分母) | 計算用 |
| de05 | 供應商代碼 | → 供應商主檔 (pbm*?) |
| de09 | 主要零件 (Y/N) | 邏輯標記 |
| de18 | 啟用標記 (Y/N) | 邏輯標記 |

**特性**:
- 定義產品的**標準組合**
- **不依賴訂單**
- 建立產品時設定
- 影響所有使用該產品的訂單

---

### 2. 銷售訂單層

#### tfm01 - 銷售主檔 (S/C Master)

**主鍵**: fa01 (S/C 編號)

| 關鍵欄位 | 關聯 |
|----------|------|
| fa01 | S/C 編號 → tfm02.fb01 |
| fa04 | 客戶編號 → khm01 客戶主檔 |
| fa05 | 業務代號 → 業務主檔 |

#### tfm02 - 銷售明細 (S/C Detail)

**主鍵**: (fb01, fb02)

| 關鍵欄位 | 關聯 |
|----------|------|
| fb01 | S/C 編號 ← tfm01.fa01 |
| fb02 | 項次序號 |
| fb03 | 產品編號 → tdm05.de01 (查詢標準 BOM) |
| fb09 | 訂購數量 | 用於 BOM 計算 |

#### tem05 - 訂單專屬組合關係

**主鍵**: (ee011, ee02, ee03)

| 關鍵欄位 | 關聯 |
|----------|------|
| ee011 | S/C 編號 ← tfm01.fa01 |
| ee02 | 主產品編號 ← tfm02.fb03 |
| ee03 | 組件編號 |
| ee04/ee05 | 比例 | 從 tdm05 複製或調整 |

**特性**:
- **訂單專屬** (可針對特定訂單調整)
- 從 tdm05 複製基礎資料
- 可以覆蓋標準設定

---

### 3. 排程層

#### tfm03 - 排程明細

**主鍵**: (fc01, fc02, fc031, fc04)

| 關鍵欄位 | 關聯 |
|----------|------|
| fc01 | S/C 編號 ← tfm01.fa01 |
| fc04 | 產品編號 ← tfm02.fb03 |
| fc05 | 排程數量 |
| fc06 | 已出貨數量 |

#### tfm04 - 排程彙總

**主鍵**: (fd01, fd02, fd03)

| 關鍵欄位 | 關聯 |
|----------|------|
| fd01 | S/C 編號 ← tfm01.fa01 |
| fd02 | ETD 預計出貨日 |
| fd06 | 總材積 | 從 tfm03 彙總 |

---

## 業務流程與資料流

### 流程 A: 新增產品

```sql
1. 建立產品基本資料
   → 產品主檔 (未確認表名，可能是 kjm*, knm* 等)

2. 設定產品組合關係
   → INSERT INTO tdm05 (標準 BOM)

3. 完成 → 產品可用於訂單
```

### 流程 B: 建立銷售訂單

```sql
1. 建立訂單主檔
   → INSERT INTO tfm01

2. 新增產品明細
   → INSERT INTO tfm02

3. 系統自動處理 (可能透過觸發器或 UI)
   → 從 tdm05 複製 BOM 到 tem05
   → ERP UI 點擊數量時，從 tem05 計算並顯示

4. 排程出貨
   → INSERT INTO tfm03 (排程明細)
   → 自動更新 tfm04 (排程彙總)
```

### 流程 C: ERP UI「點選數量」的完整流程

```
使用者點擊 tfm02.fb09 (數量欄位)
    ↓
UI DLL (xtf1i01.dll) 觸發事件
    ↓
查詢 1: 取得主產品編號 (fb03)
    ↓
查詢 2: 從 tdm05 查詢標準 BOM
    SELECT * FROM tdm05 WHERE de01 = fb03
    ↓
查詢 3: 檢查 tem05 是否已有訂單 BOM
    SELECT * FROM tem05 WHERE ee011 = fb01 AND ee02 = fb03
    ↓
如果 tem05 不存在 → 從 tdm05 複製
    INSERT INTO tem05 SELECT ... FROM tdm05
    ↓
計算組件需求數量
    需求數量 = fb09 × (de03 / de04)
    ↓
顯示組合視窗
    列出所有組件及計算後的數量
```

---

## 關鍵表格總覽

| 表格 | 用途 | 主鍵 | 關聯表 |
|------|------|------|--------|
| **tdm05** | 產品標準 BOM | (de01, de02) | 產品主檔 |
| **tem05** | 訂單專屬 BOM | (ee011, ee02, ee03) | tfm01, tfm02, tdm05 |
| **tfm01** | 銷售主檔 | fa01 | khm01, tfm02 |
| **tfm02** | 銷售明細 | (fb01, fb02) | tfm01, tdm05 |
| **tfm03** | 排程明細 | (fc01, fc02, fc031, fc04) | tfm01, tfm02 |
| **tfm04** | 排程彙總 | (fd01, fd02, fd03) | tfm01, tfm03 |
| **tqm01** | 報價主檔 | qa01 | - |
| **tqm02** | 報價明細 | (qb01, qb02) | tqm01 |
| **pom01** | 採購主檔 | (推測) | - |
| **pom02** | 採購明細 | (推測) | pom01 |

---

## 表格命名規則解析

| 前綴 | 模組 | 說明 | 範例 |
|------|------|------|------|
| **tf** | Trade/Sales | 銷售/貿易 | tfm01, tfm02 |
| **tq** | Quotation | 報價 | tqm01, tqm02 |
| **td** | Transaction | 交易/單據 | tdm05 |
| **te** | Temp/Event | 暫存/事件 | tem05 |
| **po** | Purchase Order | 採購 | pom01, pom02 |
| **k*** | 庫存相關 | Stock | khm01, ksm01 |

| 後綴 | 說明 | 範例 |
|------|------|------|
| **m01** | 主檔 Master | tfm01, tqm01 |
| **m02** | 明細 Detail | tfm02, tqm02 |
| **m03** | 排程/第3層 | tfm03 |
| **m04** | 彙總/第4層 | tfm04 |
| **m05** | BOM/組合 | tdm05, tem05 |

---

## 欄位命名規則

### 模式: `[表前綴][序號]`

| 表格 | 欄位前綴 | 範例 |
|------|----------|------|
| tfm01 | fa## | fa01, fa02, fa03... |
| tfm02 | fb## | fb01, fb02, fb03... |
| tfm03 | fc## | fc01, fc02, fc03... |
| tfm04 | fd## | fd01, fd02, fd03... |
| tdm05 | de## | de01, de02, de03... |
| tem05 | ee## | ee01, ee02, ee03... |
| tqm01 | qa## | qa01, qa02, qa03... |
| tqm02 | qb## | qb01, qb02, qb03... |

### 欄位意義規則

| 序號 | 通常意義 | 範例 |
|------|----------|------|
| ##01 | 主鍵 | fa01=S/C編號, de01=產品編號 |
| ##02 | 類型/序號/第2關鍵 | fa02=類型, fb02=項次, de02=組件編號 |
| ##03 | 日期/編號/數量 | fa03=日期, de03=比例分子 |
| ##04 | 客戶/數量 | fa04=客戶, de04=比例分母 |
| ##05 | 業務/供應商 | fa05=業務, de05=供應商 |
| ##09 | 數量/標記 | fb09=訂購數量, de09=主要零件 |

---

## 完整關聯圖 (資料流向)

```
                    ┌─────────────────┐
                    │   系統參數表     │
                    │    tsm01        │
                    │  (IC15匯率等)    │
                    └─────────────────┘
                            ↓ 提供系統參數

┌───────────────────────────────────────────────────────┐
│                     基礎主檔                           │
├───────────────────────────────────────────────────────┤
│                                                       │
│  ┌─────────────┐    ┌─────────────┐                  │
│  │   khm01     │    │   pbm01     │                  │
│  │  客戶主檔    │    │  供應商主檔  │                  │
│  └─────────────┘    └─────────────┘                  │
│         ↓                   ↓                        │
│                                                       │
│  ┌─────────────────────────────────────┐             │
│  │          產品主檔 (未確認表名)         │             │
│  │      可能是 kjm*, knm*, 或其他        │             │
│  └──────────────┬──────────────────────┘             │
│                 │                                     │
│                 ↓                                     │
│  ┌─────────────────────────────────────┐             │
│  │          tdm05                      │             │
│  │       產品標準 BOM 主檔              │             │
│  │  (定義產品的標準組合關係)            │             │
│  └──────────────┬──────────────────────┘             │
│                 │                                     │
└─────────────────┼─────────────────────────────────────┘
                  │
                  │ 建立訂單時複製
                  ↓
┌───────────────────────────────────────────────────────┐
│                   訂單處理層                           │
├───────────────────────────────────────────────────────┤
│                                                       │
│  ┌─────────────┐                                      │
│  │   tfm01     │  fa01 (S/C 編號)                     │
│  │ 銷售主檔     │                                      │
│  └──────┬──────┘                                      │
│         │                                             │
│         │ fa01 = fb01                                 │
│         ↓                                             │
│  ┌─────────────┐                                      │
│  │   tfm02     │  fb01, fb02 (S/C編號, 項次)          │
│  │ 銷售明細     │  fb03 (產品編號)                     │
│  │            │  fb09 (訂購數量) ← 關鍵！            │
│  └──────┬──────┘                                      │
│         │                                             │
│         │ 當輸入 fb03 時                               │
│         │ 觸發 DLL (xtf1i01.dll)                      │
│         │ 從 tdm05 複製 BOM                           │
│         ↓                                             │
│  ┌─────────────────────────────────────┐             │
│  │          tem05                      │             │
│  │       訂單專屬組合關係               │             │
│  │  ee011=S/C, ee02=產品, ee03=組件    │             │
│  │  ee04/ee05=比例                     │             │
│  └─────────────────────────────────────┘             │
│         │                                             │
│         │ 點擊 fb09 時觸發計算                         │
│         │ 需求數量 = fb09 × (ee04/ee05)               │
│         ↓                                             │
│   顯示組合視窗 (UI)                                   │
│                                                       │
└───────────────────────────────────────────────────────┘
                  ↓
┌───────────────────────────────────────────────────────┐
│                   排程出貨層                           │
├───────────────────────────────────────────────────────┤
│                                                       │
│  ┌─────────────┐     fc01=S/C, fc04=產品              │
│  │   tfm03     │     fc05=排程數量                    │
│  │ 排程明細     │─────────┐                           │
│  └─────────────┘         │                           │
│                          │ 彙總                       │
│                          ↓                           │
│  ┌─────────────────────────────────────┐             │
│  │          tfm04                      │             │
│  │        排程彙總主檔                  │             │
│  │  fd01=S/C, fd02=ETD, fd03=目的地    │             │
│  │  fd06=總材積, fd07=總重量            │             │
│  └─────────────────────────────────────┘             │
│                                                       │
└───────────────────────────────────────────────────────┘
```

---

## 關鍵關聯 SQL

### 查詢訂單的完整組合資訊

```sql
-- 查詢 T16C04 訂單的所有產品及其組合
SELECT
    t1.fa01 AS [S/C編號],
    t1.fa03 AS [日期],
    t1.fa04 AS [客戶],
    t2.fb02 AS [項次],
    t2.fb03 AS [產品編號],
    t2.fb09 AS [訂購數量],
    -- 組合明細
    t5.ee03 AS [組件編號],
    CAST((t2.fb09 * t5.ee04 / t5.ee05) AS DECIMAL(10,2)) AS [組件需求],
    t5.ee06 AS [供應商]
FROM tfm01 t1
INNER JOIN tfm02 t2 ON t2.fb01 = t1.fa01
LEFT JOIN tem05 t5 ON t5.ee011 = t1.fa01 AND t5.ee02 = t2.fb03
WHERE t1.fa01 = 'T16C04'
ORDER BY t2.fb02, t5.ee07;
```

### 查詢產品的標準 BOM

```sql
SELECT
    de01 AS [產品編號],
    de02 AS [組件編號],
    CAST(de03 AS VARCHAR) + ' : ' + CAST(de04 AS VARCHAR) AS [比例],
    de05 AS [供應商],
    de06 AS [BOM序號],
    de09 AS [主要零件],
    de15 AS [顯示序]
FROM tdm05
WHERE de01 = '284102'
ORDER BY de15;
```

---

## 觸發器與 Stored Procedures

### tfm02 觸發器

| 觸發器 | 事件 | 可能功能 |
|--------|------|----------|
| tr_tfm02_i | INSERT | 插入明細時，可能自動建立 tem05 |
| tr_tfm02_u | UPDATE | 更新數量時，同步更新 tem05 |
| tr_tfm02_d | DELETE | 刪除明細時，清理 tem05 |

### 相關 Stored Procedures

| SP 名稱 | 功能 |
|---------|------|
| sp_tfm02_subitemcost | 計算組合成本 |
| sp_tfm_schedule | 排程計算 |
| sp_tfm_update | 訂單更新 |
| sp_batchtotfm02 | 批次處理明細 |

---

## 資料一致性規則

### 必須維護的關聯

1. **tfm01 ↔ tfm02**
   - fb01 必須存在於 fa01
   - 刪除 tfm01 時必須先刪除 tfm02

2. **tfm02 ↔ tem05**
   - ee011 = fb01 (訂單)
   - ee02 = fb03 (產品)
   - 插入 tfm02 時建議同時建立 tem05

3. **tdm05 → tem05**
   - tem05 初始資料從 tdm05 複製
   - 可在訂單中調整，不影響 tdm05

4. **tfm02 → tfm03**
   - fc01 = fb01 (訂單)
   - fc04 = fb03 (產品)
   - fc05 ≤ (fb09 - 已排程數量)

---

## 完整資料注入流程

### 步驟 1: 確認產品 BOM 存在

```sql
-- 檢查產品是否有標準 BOM
SELECT de01, de02, de03, de04, de05
FROM tdm05
WHERE de01 = '要插入的產品編號';

-- 如果沒有，需要先建立
INSERT INTO tdm05 (de01, de02, de03, de04, de05, de06, de09, de18)
VALUES ('產品編號', '組件編號', 1.0, 1.0, '供應商', 序號, 'Y/N', 'Y');
```

### 步驟 2: 插入訂單主檔

```sql
INSERT INTO tfm01 (fa01, fa02, fa03, fa04, fa05, ...)
VALUES ('S/C編號', 'I', '20251218', '客戶', '業務', ...);
```

### 步驟 3: 插入訂單明細

```sql
INSERT INTO tfm02 (fb01, fb02, fb03, fb09, fb10, ...)
VALUES ('S/C編號', 項次, '產品編號', 數量, 'PC', ...);
```

### 步驟 4: 建立訂單 BOM (從標準 BOM 複製)

```sql
INSERT INTO tem05 (ee010, ee011, ee02, ee03, ee04, ee05, ee06, ee07, ee08, ee10)
SELECT
    'S',           -- 類型 (S=Sales)
    'S/C編號',      -- 訂單編號
    de01,          -- 主產品
    de02,          -- 組件
    de03,          -- 比例分子
    de04,          -- 比例分母
    de05,          -- 供應商
    de06,          -- 序號
    de07,          -- 損耗率
    de09           -- 主要零件
FROM tdm05
WHERE de01 = '產品編號' AND de18 = 'Y';
```

### 步驟 5: 驗證

```sql
-- 查詢組合計算結果
SELECT
    ee03 AS [組件],
    CAST((tfm02.fb09 * ee04 / ee05) AS DECIMAL(10,2)) AS [需求數量]
FROM tfm02
INNER JOIN tem05 ON ee011 = fb01 AND ee02 = fb03
WHERE fb01 = 'S/C編號' AND fb03 = '產品編號';
```

---

## 更新總結

已找到完整的表格關聯：

1. ✅ **tdm05** - 產品標準 BOM (Product BOM Master)
2. ✅ **tem05** - 訂單專屬 BOM (Order Specific BOM)
3. ✅ **tfm01/tfm02** - 銷售訂單主檔/明細
4. ✅ **tfm03/tfm04** - 排程明細/彙總
5. ✅ 資料流向：tdm05 → tem05 → 顯示

文檔已更新！現在研究「查詢主檔」...
