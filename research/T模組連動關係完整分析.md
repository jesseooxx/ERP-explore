# T 模組（國外貿易）連動關係完整分析

本文件詳細說明產品(tdm)、報價(tem)、訂單(tfm) 之間的連動機制，以及 Excel 匯入(trs) 的實現方式。

---

## 一、核心連動架構圖

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           T 模組核心資料流                                    │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌──────────────┐
                    │   Excel 匯入  │
                    │  trs01~tmp   │
                    └──────┬───────┘
                           │ 批量匯入
                           ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│  產品主檔     │───▶│   報價單     │───▶│   銷售訂單   │───▶│    出貨      │
│  tdm01~26    │    │  tem01~17   │    │  tfm01~12   │    │  thm01~12   │
└──────┬───────┘    └──────┬───────┘    └──────┬───────┘    └──────────────┘
       │                   │                   │
       │ BOM定義           │ 複製BOM           │ 複製BOM
       ▼                   ▼                   ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│  產品標準BOM  │───▶│  報價專屬BOM │───▶│  訂單專屬BOM │
│    tdm05     │    │   (tem05)    │    │    tem05    │
└──────────────┘    └──────────────┘    └──────────────┘
                                               │
                                               ▼
                                        ┌──────────────┐
                                        │   採購單     │
                                        │  tgm01~09   │
                                        └──────────────┘
```

---

## 二、表格主鍵與外鍵關係總表

### 2.1 主鍵定義

| 表格 | 主鍵 | 欄位說明 | 範例 |
|------|------|----------|------|
| **tdm01** | da01 | 產品編號 | 284102, 074027 |
| **tdm05** | (de01, de02) | 產品編號 + 組件編號 | (284102, 284102-MAIN) |
| **tem01** | ea01 | 報價編號 | Q25001 |
| **tem02** | (eb01, eb02) | 報價編號 + 項次 | (Q25001, 1) |
| **tem05** | (ee011, ee02, ee03) | 單據編號 + 產品 + 組件 | (T16C04, 284102, 284102-MAIN) |
| **tfm01** | fa01 | S/C 訂單編號 | T16C04, 00048 |
| **tfm02** | (fb01, fb02) | S/C編號 + 項次 | (T16C04, 1) |
| **tfm03** | (fc01, fc02, fc031, fc04) | S/C + ETD + 目的地 + 產品 | 出貨排程 |
| **tfm04** | (fd01, fd02, fd03) | S/C + ETD + 目的地 | 排程彙總 |

### 2.2 外鍵關聯圖

```
tdm01 (產品主檔)
  │
  ├──▶ tdm05.de01 (產品標準BOM)
  │       │
  │       └──▶ tem05.ee02 (訂單專屬BOM - 複製來源)
  │
  ├──▶ tem02.eb03 (報價產品)
  │       │
  │       └──▶ tem01.ea01 (報價主檔)
  │
  └──▶ tfm02.fb03 (訂單產品)
          │
          ├──▶ tfm01.fa01 (訂單主檔)
          │
          ├──▶ tfm03.fc04 (排程產品)
          │       │
          │       └──▶ tfm04 (排程彙總)
          │
          └──▶ tem05.ee02 (訂單BOM)
                  │
                  └──▶ tgm02 (採購明細)
```

---

## 三、產品模組 (tdm) 詳細結構

### 3.1 核心表格

| 表格 | 功能 | 關鍵欄位 |
|------|------|----------|
| **tdm01** | 產品基本資料 | da01(產品編號), da02(品名), da03(規格) |
| **tdm02** | 產品子描述 | 多行描述、技術說明 |
| **tdm05** | 產品組合關係(BOM) | de01(產品), de02(組件), de03/de04(比例) |
| **tdm06** | 產品贈品配件 | 贈品設定 |
| **tdm07** | 產品成本比例 | 成本組成分配 |
| **tdm08** | 產品包裝資料 | 外箱尺寸、淨重 |
| **tdm09** | 產品價格等級 | 價格級別設定 |

### 3.2 tdm05 (產品標準BOM) 完整欄位

| 欄位 | 型態 | 說明 | 範例 |
|------|------|------|------|
| **de01** | varchar(20) | 主產品編號 (PK1) | 284102 |
| **de02** | varchar(20) | 組件編號 (PK2) | 284102-MAIN |
| **de03** | float | 比例分子 | 1.0 |
| **de04** | float | 比例分母 | 100.0 |
| **de05** | varchar(10) | 供應商代碼 | 2279 |
| **de06** | int | BOM 序號 | 1 |
| **de07** | float | 損耗率(%) | 0.0 |
| **de08** | varchar(7500) | 備註 | (長文本) |
| **de09** | char(1) | 主要零件標記 | Y/N |
| **de15** | float | 顯示序號 | 1.0, 2.0 |
| **de18** | varchar(1) | 啟用標記 | Y/N |

**BOM 計算公式**:
```
組件需求數量 = 訂購數量 × (de03 / de04)
```

---

## 四、報價模組 (tem) 詳細結構

### 4.1 核心表格

| 表格 | 功能 | 關鍵欄位 |
|------|------|----------|
| **tem01** | 報價單主檔 | ea01(報價編號), ea02(客戶), ea03(日期) |
| **tem02** | 報價產品資料 | eb01(報價編號), eb03(產品), eb09(數量), eb11(單價) |
| **tem03** | 原始單據備註 | 備註說明 |
| **tem04** | 產品多行描述 | 產品詳細描述 |
| **tem05** | 報價/訂單產品組合 | 特定單據的BOM |
| **tem06** | 產品成本比例 | 成本分配 |
| **tem07** | 加扣款 | 額外費用項目 |
| **tem08** | 利潤分析 | 成本/售價/毛利 |

### 4.2 tem05 (訂單專屬BOM) 完整欄位

| 欄位 | 型態 | 說明 | 範例 |
|------|------|------|------|
| **ee010** | char(1) | 單據類型 | S=Sales, Q=Quote |
| **ee011** | varchar | 單據編號 (PK1) | T16C04 |
| **ee02** | varchar | 主產品編號 (PK2) | 284102 |
| **ee03** | varchar | 組件編號 (PK3) | 284102-MAIN |
| **ee04** | float | 比例分子 | 1.0 |
| **ee05** | float | 比例分母 | 100.0 |
| **ee06** | varchar | 供應商代碼 | 02291 |
| **ee07** | float | 序號 | 1, 2, 3 |
| **ee08** | float | 損耗率 | 0.0 |
| **ee10** | char(1) | 主要零件標記 | Y/N |

---

## 五、訂單模組 (tfm) 詳細結構

### 5.1 核心表格

| 表格 | 功能 | 主鍵 |
|------|------|------|
| **tfm01** | 訂單主檔 | fa01 (S/C編號) |
| **tfm02** | 訂單明細 | (fb01, fb02) |
| **tfm03** | 排程明細 | (fc01, fc02, fc031, fc04) |
| **tfm04** | 排程彙總 | (fd01, fd02, fd03) |
| **tfm05** | 訂單選擇採購單 | 連接採購單 |
| **tfm09~12** | 報關合同相關 | 國際貿易報關 |

### 5.2 tfm01 (訂單主檔) 關鍵欄位

| 欄位 | 說明 | 範例 |
|------|------|------|
| **fa01** | S/C 訂單編號 | 00048, T16C04 |
| **fa03** | 建立日期 | 20121224 |
| **fa04** | 客戶編號 | 498 |
| **fa05** | 業務代號 | I04 |
| **fa08** | 客戶訂單號 | 2011-10230 |
| **fa11** | 起運港 | SHANGHAI |
| **fa14** | 目的港 | ROTTERDAM |
| **fa17** | 貿易條件代碼 | FOB |
| **fa19** | 幣別 | US$ |
| **fa20** | 匯率 | 30.6 |
| **fa32** | 預計出貨日 | 20111026 |
| **fa37** | 總金額 | 7282 |
| **fa63** | 完成標記 | Y/N |
| **fa64** | 取消標記 | Y/N |

### 5.3 tfm02 (訂單明細) 關鍵欄位

| 欄位 | 說明 | 範例 |
|------|------|------|
| **fb01** | S/C 編號 (FK) | 00048 |
| **fb02** | 項次序號 | 1, 2, 3 |
| **fb03** | 產品編號 | CN-91200100 |
| **fb06** | 品名第1行 | Composter ABB650 |
| **fb09** | 訂購數量 | 200 |
| **fb10** | 單位 | PC, UNIT |
| **fb11** | 單價 | 1 |
| **fb12** | 金額 | 182.87 |
| **fb13** | 供應商代碼 | A19073 |
| **fb23** | 外箱裝數量 | 1 |
| **fb25** | 外箱材積 | 0.5 (CBM) |
| **fb53** | 完成標記 | Y/N |

---

## 六、核心連動機制

### 6.1 產品 → 報價 連動

```
Step 1: 選擇產品
┌─────────────┐
│ 用戶選擇產品 │
│ tdm01.da01  │
└──────┬──────┘
       │
Step 2: 帶入產品資料
       ▼
┌─────────────────────────────────────┐
│ 自動帶入:                           │
│ - 產品編號 → tem02.eb03            │
│ - 品名 → tem02.eb06                │
│ - 預設單價 → tem02.eb11            │
│ - 包裝資料 → 從 tdm08              │
└──────┬──────────────────────────────┘
       │
Step 3: 複製 BOM
       ▼
┌─────────────────────────────────────┐
│ 觸發器自動執行:                      │
│ INSERT INTO tem05                   │
│ SELECT * FROM tdm05                 │
│ WHERE de01 = '選擇的產品編號'        │
└─────────────────────────────────────┘
```

### 6.2 報價 → 訂單 連動

```
Step 1: 確認報價
┌─────────────┐
│ 報價單確認   │
│ tem01.ea01  │
└──────┬──────┘
       │
Step 2: 一鍵轉訂單
       ▼
┌─────────────────────────────────────┐
│ 系統自動建立:                        │
│ 1. tfm01 (訂單主檔)                 │
│    - 複製客戶、幣別、匯率等          │
│ 2. tfm02 (訂單明細)                 │
│    - 複製產品、數量、單價            │
│ 3. tem05 (更新單據編號)             │
│    - ee011 改為 S/C 編號            │
└──────┬──────────────────────────────┘
       │
Step 3: 建立排程
       ▼
┌─────────────────────────────────────┐
│ 手動或自動分批:                      │
│ - tfm03 (排程明細)                  │
│ - tfm04 (排程彙總)                  │
└─────────────────────────────────────┘
```

### 6.3 訂單 → 採購 連動

```
┌─────────────────────────────────────┐
│           訂單轉需求作業              │
└─────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────┐
│ 1. 讀取訂單明細 (tfm02)              │
│ 2. 查詢訂單 BOM (tem05)              │
│ 3. 計算組件需求量                    │
│    需求 = fb09 × (ee04/ee05)        │
│ 4. 按供應商分組建立採購單            │
│    - tgm01 (採購主檔)               │
│    - tgm02 (採購明細)               │
│ 5. 記錄對應關係 (tfm05)              │
└─────────────────────────────────────┘
```

### 6.4 訂單分批出貨機制

```
┌─────────────────────────────────────────────────────────────┐
│                      分批出貨流程                            │
└─────────────────────────────────────────────────────────────┘

1. 建立訂單 (tfm01 + tfm02)
   fb09 = 1000 (總數量)
       │
2. 分批排程
       ▼
   ┌───────────────────────────────────────────────┐
   │ tfm03 排程明細                                 │
   ├───────────────────────────────────────────────┤
   │ 第1批: fc02=20251230, fc05=500, fc06=0        │
   │ 第2批: fc02=20260110, fc05=500, fc06=0        │
   └───────────────────────────────────────────────┘
       │
3. 彙總計算
       ▼
   ┌───────────────────────────────────────────────┐
   │ tfm04 排程彙總                                 │
   │ fd06 = 總材積 = Σ(fc05 × fb25/fb23)           │
   └───────────────────────────────────────────────┘
       │
4. 轉出貨單 (thm01 + thm02)
       │
5. 更新已出貨量
       ▼
   fc06 (已出貨) += 本次出貨量
   當 fc06 >= fc05 時，fc08 = 'Y' (完成)
```

---

## 七、BOM 優先順序機制

```
查詢產品組合時的優先順序：

1. 客戶專屬 BOM (如 qem21)
   ↓ 如無
2. 訂單專屬 BOM (tem05)
   ↓ 如無
3. 產品標準 BOM (tdm05)
   ↓ 如無
4. 錯誤提示：該產品無 BOM 定義
```

---

## 八、Excel 匯入機制 (trs)

### 8.1 表格結構

| 表格 | 功能 | 說明 |
|------|------|------|
| **trs01** | 匯入設定檔 | 定義匯入配置、目標表格 |
| **trs02** | 來源文件記錄 | 記錄上傳的 Excel 文件 |
| **trs03** | 欄位映射規則 | Excel 欄位 → 資料庫欄位 |
| **trs_tmp** | 臨時處理表 | 驗證和轉換過程中使用 |

### 8.2 匯入流程

```
┌─────────────────────────────────────────────────────────────┐
│                     Excel 匯入完整流程                        │
└─────────────────────────────────────────────────────────────┘

Step 1: 配置設定 (管理員)
┌────────────────────────────────────┐
│ trs01: 定義匯入規則                 │
│ - 配置名稱: "貿易訂單導入"          │
│ - 目標表格: tfm01, tfm02, tem05    │
└────────────────────────────────────┘
        │
Step 2: 欄位映射 (管理員)
        ▼
┌────────────────────────────────────┐
│ trs03: 定義欄位對應                 │
│ - Excel A1 → tfm01.fa01 (S/C編號)  │
│ - Excel B1 → tfm01.fa04 (客戶)     │
│ - Excel C1 → tfm02.fb03 (產品)     │
│ - Excel D1 → tfm02.fb09 (數量)     │
└────────────────────────────────────┘
        │
Step 3: 用戶上傳
        ▼
┌────────────────────────────────────┐
│ trs02: 記錄上傳資訊                 │
│ - 文件名: SalesOrder_20251218.xlsx │
│ - 上傳時間: 2025-12-18 10:30       │
│ - 狀態: 待處理                      │
└────────────────────────────────────┘
        │
Step 4: 驗證處理
        ▼
┌────────────────────────────────────┐
│ trs_tmp: 臨時驗證                   │
│ - 檢查必填欄位                      │
│ - 驗證外鍵存在                      │
│ - 類型轉換                          │
│ - 記錄錯誤                          │
└────────────────────────────────────┘
        │
Step 5: 批量插入
        ▼
┌────────────────────────────────────┐
│ 插入目標表格:                       │
│ - tfm01 (訂單主檔)                 │
│ - tfm02 (訂單明細)                 │
│ - tem05 (自動複製 BOM)             │
└────────────────────────────────────┘
        │
Step 6: 清理與記錄
        ▼
┌────────────────────────────────────┐
│ - 清除 trs_tmp                     │
│ - 更新 trs02 狀態: 已完成           │
│ - 記錄: 成功 100 筆, 失敗 0 筆      │
└────────────────────────────────────┘
```

### 8.3 欄位映射範例

```
Excel 文件:
┌────┬────────────┬──────────┬──────────┬──────────┐
│    │ A (Col=1)  │ B (Col=2)│ C (Col=3)│ D (Col=4)│
├────┼────────────┼──────────┼──────────┼──────────┤
│ 1  │ S/C 編號   │ 客戶編號 │ 產品編號 │ 數量     │
│ 2  │ T25C01     │ 491      │ 284102   │ 1000     │
│ 3  │ T25C02     │ 492      │ 074027   │ 32       │
└────┴────────────┴──────────┴──────────┴──────────┘

trs03 映射規則:
┌──────────┬─────────────┬─────────────┬────────────┐
│ Excel位置 │ DB欄位      │ 類型        │ 驗證規則    │
├──────────┼─────────────┼─────────────┼────────────┤
│ Col=1    │ tfm01.fa01  │ VARCHAR(10) │ REQUIRED   │
│ Col=2    │ tfm01.fa04  │ VARCHAR(10) │ LOOKUP=tbm01│
│ Col=3    │ tfm02.fb03  │ VARCHAR(20) │ LOOKUP=tdm01│
│ Col=4    │ tfm02.fb09  │ FLOAT       │ RANGE=1,999999│
└──────────┴─────────────┴─────────────┴────────────┘
```

---

## 九、實用 SQL 查詢範例

### 9.1 查詢訂單完整資料 (含 BOM)

```sql
-- 訂單基本資料 + 明細 + BOM
SELECT
    t1.fa01 AS [訂單編號],
    t1.fa04 AS [客戶],
    t1.fa03 AS [日期],
    t2.fb02 AS [項次],
    t2.fb03 AS [產品編號],
    t2.fb09 AS [訂購數量],
    t5.ee03 AS [組件編號],
    CAST((t2.fb09 * t5.ee04 / t5.ee05) AS DECIMAL(10,2)) AS [組件需求]
FROM tfm01 t1
INNER JOIN tfm02 t2 ON t2.fb01 = t1.fa01
LEFT JOIN tem05 t5 ON t5.ee011 = t1.fa01 AND t5.ee02 = t2.fb03
WHERE t1.fa01 = 'T16C04'
ORDER BY t2.fb02, t5.ee07;
```

### 9.2 查詢產品標準 BOM

```sql
SELECT
    de01 AS [產品編號],
    de02 AS [組件編號],
    CAST(de03 AS VARCHAR) + '/' + CAST(de04 AS VARCHAR) AS [比例],
    de05 AS [供應商],
    CASE de09 WHEN 'Y' THEN '主要' ELSE '次要' END AS [類型],
    de15 AS [序號]
FROM tdm05
WHERE de01 = '284102' AND de18 = 'Y'
ORDER BY de15;
```

### 9.3 計算訂單所需採購量

```sql
DECLARE @OrderNo VARCHAR(10) = 'T16C04';

SELECT
    t5.ee06 AS [供應商],
    t5.ee03 AS [組件],
    SUM(CAST((t2.fb09 * t5.ee04 / t5.ee05) AS DECIMAL(10,2))) AS [總需求]
FROM tfm02 t2
INNER JOIN tem05 t5 ON t5.ee011 = t2.fb01 AND t5.ee02 = t2.fb03
WHERE t2.fb01 = @OrderNo
GROUP BY t5.ee06, t5.ee03
ORDER BY t5.ee06;
```

---

## 十、資料一致性規則

### 10.1 必須維護的關聯

| 操作 | 規則 |
|------|------|
| 刪除 tfm01 | 必須先刪除 tfm02, tfm03, tfm04, tem05 |
| 刪除 tfm02 | 必須先刪除對應的 tem05, tfm03 |
| 修改 fb09 (數量) | 自動更新 tem05 組件計算 |
| 新增 tfm02 | 自動從 tdm05 複製 BOM 到 tem05 |

### 10.2 檢查約束

```sql
-- 排程數量不能超過訂購數量
CHECK: SUM(tfm03.fc05) <= tfm02.fb09

-- 已出貨不能超過排程
CHECK: tfm03.fc06 <= tfm03.fc05

-- BOM 比例分母不能為 0
CHECK: tdm05.de04 > 0 AND tem05.ee05 > 0
```

---

## 十一、總結

### 連動關係總覽

| 來源 | 目標 | 連動方式 | 觸發時機 |
|------|------|----------|----------|
| tdm05 | tem05 | 複製 BOM | 建立訂單/報價時 |
| tem01/02 | tfm01/02 | 轉換單據 | 報價確認時 |
| tfm02 | tfm03/04 | 建立排程 | 手動分批時 |
| tfm02 + tem05 | tgm01/02 | 轉採購單 | 訂單轉需求時 |
| tfm03 | thm01/02 | 轉出貨單 | 出貨作業時 |
| trs01~03 | tfm01/02 | Excel 匯入 | 批量導入時 |

### 關鍵計算公式

```
組件需求 = 訂購數量 × (比例分子 / 比例分母)
材積 = 出貨數量 × (外箱材積 / 外箱裝數)
利潤率 = (售價 - 成本) / 售價 × 100%
```

---

**文件建立日期**: 2025-12-22
**資料來源**: Agent 深度研究整合
