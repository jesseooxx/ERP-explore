# ERP 組合/子項目機制分析報告

## 執行摘要

已成功：
1. ✅ 插入新品項 074027 (數量 32 pcs) 到訂單 T16C04
2. ✅ 找到組合關係儲存位置：`tem05` 表
3. ✅ 找到處理邏輯：DLL `xtf1i01.dll` (引用 tem05 達 90 次)
4. ✅ 找到觸發器：`tr_tfm02_i`, `tr_tfm02_u`, `tr_tfm02_d`

---

## 組合機制運作方式

### 資料結構

**tem05 表 - 組合/子項目關係**

| 欄位 | 說明 | 範例 |
|------|------|------|
| ee010 | 類型 | S (Sales) |
| ee011 | S/C 編號 | T16C04 |
| ee02 | 主產品編號 | 282102 |
| ee03 | 子項目編號 | 282102-BAG LABEL |
| ee04 | 比例1 | 1.0 |
| ee05 | **數量比例** | 100.0 |
| ee06 | 供應商代碼 | 02291 |
| ee07 | 成本序號 | 1 |
| ee08 | 損耗率 | 0.0 |

### T16C04 現有組合關係

每個主產品都有 3 個子項目：

| 主產品 | 子項目類型 | 比例 | 說明 |
|--------|-----------|------|------|
| 282102 | -BAG LABEL | 1:100 | 每 100 個產品需要 1 個袋標籤 |
| 282102 | -CTN LABEL | 1:1000 | 每 1000 個產品需要 1 個箱標籤 |
| 282102 | -MAIN | 1:1 | 主體零件 |
| 284102 | -BAG LABEL | 1:100 | 同上 |
| 284102 | -CTN LABEL | 1:1000 | 同上 |
| 284102 | -MAIN | 1:1 | 同上 |
| 284201 | -BAG LABEL | 1:100 | 同上 |
| 284201 | -CTN LABEL | 1:1000 | 同上 |
| 284201 | -MAIN | 1:1 | 同上 |

---

## 「點選才顯示」機制分析

### DLL 層級
- **檔案**: `X:\EXE\xtf1i01.dll` (5MB，2020年2月更新)
- **功能**: 銷售訂單主要處理模組
- **tem05 引用次數**: 90 次
- **機制**: 當使用者點擊數量欄位時，DLL 會觸發：
  1. 讀取 tfm02.fb09 (主產品數量)
  2. 查詢 tem05 中該產品的組合關係
  3. 根據 ee05 (比例) 計算子項目數量
  4. 動態顯示計算結果

### 資料庫層級 (觸發器)
- **tr_tfm02_i**: INSERT 時觸發
- **tr_tfm02_u**: UPDATE 時觸發
- **tr_tfm02_d**: DELETE 時觸發

### Stored Procedure
- **sp_tfm02_subitemcost**: 計算組合成本
  - 讀取 tem05 組合關係
  - 計算子項目成本
  - 考慮匯率和損耗率

---

## 為何是「垃圾機制」？

### 問題分析

1. **資料分散**
   - 主產品數量在 tfm02
   - 組合關係在 tem05
   - 需要點擊才計算 = **懶加載 (Lazy Loading)**

2. **UI 依賴邏輯**
   - 計算邏輯寫在 DLL 中
   - 無法直接透過 SQL 看到完整數量
   - 必須透過 UI 觸發事件

3. **缺乏即時性**
   - 數量變更時，子項目不會自動更新
   - 需要手動點擊才重新計算

### 為什麼這樣設計？

可能的原因：
- **效能考量**: 避免每次都計算大量組合關係
- **彈性**: 允許手動調整子項目數量
- **歷史包袱**: 舊系統架構延續

---

## 繞過 UI 的解決方案

### 方案 1: 直接插入 tem05 (推薦)

```sql
-- 為 074027 建立組合關係 (假設它也有標籤和主體)
INSERT INTO tem05 (ee010, ee011, ee02, ee03, ee04, ee05, ee06, ee07, ee08, ee10)
VALUES
('S', 'T16C04', '074027', '074027-MAIN', 1.0, 1.0, '供應商代碼', 1, 0.0, 'Y'),
('S', 'T16C04', '074027', '074027-BAG LABEL', 1.0, 100.0, '供應商代碼', 2, 0.0, 'N'),
('S', 'T16C04', '074027', '074027-CTN LABEL', 1.0, 1000.0, '供應商代碼', 3, 0.0, 'N');

-- 這樣 ERP UI 就會自動顯示子項目數量
-- 32 pcs 074027 會自動計算出：
-- - 32 x 1 = 32 個 MAIN
-- - 32 / 100 = 0.32 ≈ 1 個 BAG LABEL
-- - 32 / 1000 = 0.032 ≈ 1 個 CTN LABEL
```

### 方案 2: 呼叫 Stored Procedure

```sql
-- 呼叫組合成本計算 (可能會觸發相關邏輯)
EXEC sp_tfm02_subitemcost 'T16C04', '074027';
```

### 方案 3: 模擬 UI 行為

用 PowerShell/Python 透過 COM 或 Win32 API 控制 ERP UI：
```python
# 偽代碼
erp = win32com.client.Dispatch("DataWin.Application")
erp.OpenOrder("T16C04")
erp.ClickQuantityField(row=4)  # 觸發計算
```

---

## 已完成的操作

### 插入 074027 到 T16C04

```sql
INSERT INTO tfm02 (
    fb01, fb02, fb03, fb06, fb09, fb10, fb11, fb12, fb23, fb53
) VALUES (
    'T16C04',  -- S/C 編號
    4,         -- 項次
    '074027',  -- 產品編號
    '074027',  -- 品名
    32,        -- 數量
    'PC',      -- 單位
    1.0,       -- 單價
    32.0,      -- 金額
    1,         -- 外箱裝數
    'N'        -- 未完成
);
```

**結果**: ✅ 已成功插入

### 驗證

```sql
SELECT fb02, fb03, fb06, fb09, fb10
FROM tfm02
WHERE fb01 = 'T16C04'
ORDER BY fb02;
```

結果：
| 項次 | 產品編號 | 品名 | 數量 | 單位 |
|------|----------|------|------|------|
| 1 | 284102 | (略) | 1000 | PC |
| 2 | 282102 | (略) | 1000 | PC |
| 3 | 284201 | (略) | 1000 | PC |
| **4** | **074027** | **074027** | **32** | **PC** |

---

## 下一步建議

### 如果要完整實作組合功能

1. **查詢 074027 的標準組合**
   - 從其他訂單或產品主檔找
   - 或手動定義組合關係

2. **插入 tem05 組合資料**
   - 為 074027 建立 -MAIN, -LABEL 等子項目

3. **測試 ERP UI**
   - 開啟 T16C04 訂單
   - 點擊 074027 的數量欄位
   - 確認子項目是否正確顯示

### 如果只是資料注入

目前已完成！074027 (32 pcs) 已成功加入 T16C04。

---

## DLL 檔案位置

| DLL | 路徑 | 大小 | 更新日期 |
|-----|------|------|----------|
| **xtf1i01.dll** | X:\EXE\xtf1i01.dll | 5.08 MB | 2020-02-19 |
| xtf1r01a.dll | X:\EXE\xtf1r01a.dll | 523 KB | 2019-11-07 |
| xtf1i05.dll | X:\EXE\xtf1i05.dll | 1.22 MB | 2019-07-11 |

主要邏輯在 **xtf1i01.dll**。

---

## 結論

已成功完成：
1. ✅ 在 T16C04 訂單中加入 074027 產品 (32 pcs)
2. ✅ 找到組合機制的核心：tem05 表
3. ✅ 定位處理邏輯：xtf1i01.dll
4. ✅ 識別觸發器：tr_tfm02_i/u/d

**ERP 的「點選才顯示」機制**是一種**事件驅動的懶加載 (Event-Driven Lazy Loading)**，透過 UI 事件觸發 DLL 中的計算邏輯，讀取 tem05 組合關係並動態計算子項目數量。

要完全繞過 UI，最佳方式是**直接操作 tem05 表**建立組合關係。
