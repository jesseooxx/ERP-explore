# 座標修正進度報告

## 測試時間
2025-12-23

## 修正內容

### ✅ 已完成

1. **座標轉換修正**
   ```python
   # 舊版（錯誤）
   DW_TO_POINTS = 0.1 * (72 / 25.4) ≈ 0.283

   # 新版（修正）
   scale_x = page_width / 900   # A4: 595/900 ≈ 0.661
   scale_y = page_height / 1200  # A4: 842/1200 ≈ 0.702
   ```

2. **多頁渲染實現**
   - 從 1 頁 → 7 頁
   - 添加了分頁檢測邏輯

3. **數據綁定**
   - 添加了實際數據
   - EDIT 字段顯示真實值而非佔位符

## 當前狀態

### 生成結果對比

| 項目 | 原始 ERP | 第一版 | 修正版 | 狀態 |
|------|---------|-------|-------|------|
| **頁數** | 4 頁 | 1 頁 | 7 頁 | ⚠️ 改善但仍不對 |
| **文件大小** | 203 KB | 1517 KB | 1520 KB | ❌ 仍太大 |
| **座標** | 正確 | 錯誤 | 部分修正 | ⚠️ 需驗證 |
| **數據** | 完整 | 空白 | 部分 | ⚠️ 需更多 |

### 分頁分析

**原始 ERP (4頁)**:
```
頁 1: 發票頭 + 客戶信息
頁 2: 商品明細表 (第1部分)
頁 3: 商品明細表 (第2部分)
頁 4: 簽名確認
```

**修正版 (7頁)**:
```
頁 1: 所有文本內容 (81個PLANK) ← 太多了！
頁 2: 圖片 PLANK 999-1000
頁 3: 圖片 PLANK 1001-1002
頁 4: 圖片 PLANK 1003-1004
頁 5-7: 其他圖片 (可能重複)
```

## 問題分析

### 問題 1: 頁數不匹配

**原因**: 分頁邏輯過於簡單
- 當前邏輯: 將所有非圖片PLANK放第1頁，圖片每2個一頁
- 實際需求: 根據內容類型和Y座標智能分頁

**解決方案**:
```python
def _detect_pages_v2(self, document):
    """改進的分頁檢測"""
    # 規則1: 按PLANK ID範圍分組
    # 規則2: 按Y座標分組
    # 規則3: 按內容類型分組
    # 規則4: 考慮頁面高度限制
```

### 問題 2: 文件過大

**原因**:
1. 可能座標仍有問題導致內容重疊
2. ReportLab 未開啟壓縮
3. 圖片處理不當

**解決方案**:
```python
# 啟用壓縮
canvas.Canvas(output, pageCompression=1)

# 優化圖片
# 檢查重複內容
```

### 問題 3: 座標驗證

**需要驗證**:
- 文字是否在正確位置？
- 對齊是否正確？
- 線條是否準確？

**方法**: 視覺對比 output/test_corrected.pdf vs nrp_backup/sample_PI.pdf

## 下一步行動

### 優先級 1: 驗證座標正確性 ⭐⭐⭐

**行動**: 手動打開兩個PDF，對比：
1. 標題 "PROFORMA INVOICE" 位置
2. "PAGE : 1" 位置
3. 客戶信息位置
4. 表格對齊

### 優先級 2: 修正分頁邏輯 ⭐⭐

需要回答：
1. 原始PDF如何決定哪些內容在哪一頁？
2. 是否有隱藏的分頁標記？
3. 商品明細表如何跨頁？

**可能需要**:
- 查看 .tmp 文件是否有額外的分頁信息
- 分析PLANK ID的分佈模式
- 考慮內容高度累積

### 優先級 3: 啟用PDF壓縮 ⭐

簡單修改：
```python
self.canvas = canvas.Canvas(output, pagesize=self.page_size, pageCompression=1)
```

預期效果: 文件大小減少 30-50%

## 測試文件

```
output/
├── test_fast.pdf         # 第一版 (1頁, 1517 KB)
├── test_orig.pdf         # 原始渲染器 (1頁, 1519 KB)
└── test_corrected.pdf    # 修正版 (7頁, 1520 KB) ← 最新
```

## 關鍵問題待解決

### ❓ 座標是否正確？

**測試方法**:
1. 打開 `output/test_corrected.pdf`
2. 檢查 "PROFORMA INVOICE" 是否在頁面頂部中央
3. 檢查表格是否對齊
4. 檢查數字是否在正確位置

**如果座標正確** → 繼續修正分頁
**如果座標錯誤** → 先修正座標轉換

### ❓ 為什麼原始PDF是4頁而不是7頁？

**可能性**:
1. 圖片不應該單獨成頁
2. 圖片可能是嵌入式而非單獨PLANK
3. 分頁邏輯基於內容而非PLANK數量

### ❓ 如何獲得準確的分頁信息？

**方案A**: 分析原始PDF結構
```bash
# 使用 pdfinfo 或 pdftk 查看PDF內部結構
```

**方案B**: 逐頁提取文字對比
```python
# 提取每頁文字，匹配到模板元素
```

**方案C**: 嘗試不同的分頁策略直到匹配

## 總結

### 進展

✅ 座標轉換: 從完全錯誤 → 部分修正
✅ 分頁: 從單頁 → 多頁
✅ 數據: 從佔位符 → 實際值

### 待辦

⚠️ 驗證座標準確性
⚠️ 修正分頁邏輯 (4頁 vs 7頁)
⚠️ 減少文件大小
⚠️ 完整數據綁定

### 建議

**立即行動**:
1. 視覺檢查 `output/test_corrected.pdf`
2. 確認座標是否基本正確
3. 根據結果決定下一步：
   - 如果座標OK → 專注於分頁邏輯
   - 如果座標錯誤 → 繼續調整座標轉換

---

*報告生成: 2025-12-23*
*狀態: 70% 完成，需要用戶反饋座標準確性*
