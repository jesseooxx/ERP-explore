# 成本風險檢查工具

## 解決什麼問題？

業務在回簽客戶訂單前，需要確認產品成本是否還有效。常見的痛點：

1. **報價過時**：供應商報價可能是 3 年前的，原物料早就漲價了
2. **人工檢查耗時**：每張訂單可能有 10-20 個產品，逐一查 ERP 很慢
3. **漏掉風險**：忙的時候容易忽略，等到要採購才發現成本對不上

這個工具可以**批次檢查多個產品**，自動標示哪些需要先跟工廠確認價格。

## 風險判斷邏輯

| 風險 | 條件 | 為什麼？ | 建議 |
|------|------|----------|------|
| 🔴 高風險 | 報價 > 2年 且 採購 > 1年 | 很久沒買了，工廠很可能已經漲價 | 回簽前先問工廠 |
| 🟡 中風險 | 報價 > 2年 但 採購 ≤ 1年 | 雖然報價舊，但最近有買過且沒被漲價 | 留意，但短期風險較低 |
| 🟢 低風險 | 報價 ≤ 2年 | 報價還算新 | 正常處理 |

## 輸出範例

```
📋 成本風險檢查（T17104）

| 風險 | 產品編號 | 成本多久 | 採購多久 | 建議 | 工廠 | 報價日期 | 最後採購日 |
|------|----------|---------|---------|------|------|----------|-----------|
| 🔴 | 388-110 | 4年2月 | 1年 | 先問工廠 | 2275 | 2013-11 | 2017-01 |
| 🔴 | 284102 | 2年5月 | 3年6月 | 先問工廠 | B02 | 2015-08 | 2014-07 |
| 🟡 | 091042 | 2年3月 | 8月 | 留意 | 2338 | 2015-10 | 2017-05 |
| 🟢 | 310052 | 1年2月 | 6月 | - | A01 | 2016-11 | 2017-07 |

⚠️ 2 個高風險、1 個中風險，建議回簽前確認
```

## 資料來源

工具查詢 ERP 資料庫的以下表格：

| 資料 | 表格 | 欄位 |
|------|------|------|
| 最新供應商報價 | `tcm05` | `ce07`（報價日期）、`ce06`（單價）、`ce011`（供應商） |
| 最後採購日期 | `tgm01` + `tgm02` | `ga03`（採購單日期） |
| 供應商名稱 | `tcm01` | `ca02` |

## 安裝

確保已安裝 Python 和 pyodbc：

```bash
pip install pyodbc
```

需要能連線到 DATAWIN 資料庫（Windows 驗證）。

## 使用方式

### 基本使用

```bash
# 檢查單一產品
python -m cost_risk_checker.main 284102

# 檢查多個產品
python -m cost_risk_checker.main 284102 284006 310052

# 從檔案讀取（每行一個產品編號）
python -m cost_risk_checker.main --file products.txt

# 加上訂單編號當標題
python -m cost_risk_checker.main 284102 284006 --title "客戶訂單-12345"
```

### 輸出 CSV

```bash
python -m cost_risk_checker.main 284102 284006 --csv report.csv
```

CSV 可以用 Excel 開啟，方便進一步處理或存檔。

### 調整門檻

預設是報價超過 2 年視為過時，可以調整：

```bash
# 成本超過 3 年才視為過時
python -m cost_risk_checker.main 284102 --threshold-years 3
```

## 典型使用流程

1. 收到客戶訂單 PDF
2. 從訂單中抽出產品編號清單
3. 執行 `python -m cost_risk_checker.main <產品編號...>`
4. 看到 🔴 高風險的產品，先聯絡工廠確認價格
5. 確認無誤後再回簽訂單

## 檔案結構

```
cost_risk_checker/
├── __init__.py      # 模組入口
├── config.py        # 資料庫連線與門檻設定
├── queries.py       # SQL 查詢
├── checker.py       # 風險評估邏輯
├── formatter.py     # 輸出格式化（表格、CSV）
├── main.py          # CLI 入口
├── security.py      # 唯讀查詢保護
├── test_checker.py  # 單元測試
└── test_integration.py  # 整合測試
```
